# AnarduinoMiniWireless-TTN-Getting-Started
A guide to connecting the Anarduino MiniWireless (US915) to The Things Network using OTAA.

## Intro
The Anarduino MiniWireless LoRa board consists of an ATMEGA328p microcontroller connected to a HopeRF RFM95 LoRa radio module. This tutorial is for the **US915** band. Other bands will not work using these instructions, the differences are significant.
The IBM LMIC framework is an Arduino port of the LoRaWAN-in-C framework provided by IBM.

The US915 LoRaWAN band is divided into 72 sub channels. Each gateway uses 8 of these sub channels. 
The Things Network uses sub channels 8-15. The example sketch demonstrates how to configure the LMIC to easily join any Things Network gateway in the US915 band. 

### Hardware
* Solder a 78mm length of wire to the antenna pin.
* Solder 3 jumpers to enable the MiniWireless to function as a LoRaWAN node using LMIC.
### Software
* Install the IBM LMIC framework for Arduino.
* Modify the library directly so that it will work in the US915 band and with our specific radio.
* In the config of the example sketch, modify the Device EUI, Application EUI and Application Key parameters taken from The Things Network registration.
* In the config of the example sketch, modify the pin mapping specifically for the Anarduino.
---
### Required hardware modifications to the Anarduino MiniWireless LoRA
* Cut 78mm of wire and solder to the pin marked `ANT`. This is a 1/4 wave dipole for 915MHz.
* Solder jumpers from the Anarduino directly to the RFM95 module. Pin 3 to RST. Pin 7 to DIO2. Pin 8 to DIO1.
![LMIC Jumpers](https://github.com/bborncr/AnarduinoMiniWireless-TTN-Getting-Started/blob/master/images/rfm95w.png)
### Install the IBM LMIC framework for Arduino
In the Arduino IDE Library Manager select and install **IBM LMIC framework by IBM Version 1.5.0+arduino-2**
![Library Screenshot](https://github.com/bborncr/AnarduinoMiniWireless-TTN-Getting-Started/blob/master/images/lmic-library.PNG)
### Library Modifications
These modifications must be done directly in the installed library.
The following files to modifiy will be relative to **Arduino-->libraries-->IBM_LMIC_framework**.
#### Change the SPI Clock Frequency
* Navigate and edit `src-->hal-->hal.cpp`
* Locate the line SPISettings and set to the following `static const SPISettings settings(8E6, MSBFIRST, SPI_MODE0);`
The only change is the constant from `10E6` to `8E6`
#### Set the frequency band and radio type
* Navigate and edit `src-->lmic-->config.h`
* Ensure that the US915 band is selected and the EU868 band is commented out.
```
//#define CFG_eu868 1
#define CFG_us915 1
```
* Ensure that the correct radio is selected 
```
// This is the SX1276/SX1277/SX1278/SX1279 radio, which is also used on
// the HopeRF RFM95 boards.
#define CFG_sx1276_radio 1
```
### Example Sketch
Before the next section please register an account on The Things Network (https://thethingsnetwork.org).
The example sketch can be found in the folder `ttn-anarduino-otaa`. This sketch is different from the default example sketch and contains changes that are required for the US915 band and TTN.
#### Register a new Device in The Things Network
* In the Console select Applications-->Register Application.
* Add an Applications ID. In my case `ttn-getting-started`.
* The Description is optional.
* Do not change the Application EUI, the system will generate the ID automatically.
* For the Handler registration choose the region closest to your location. I chose `ttn-handler-us-west`.
* Click on Add Application to continue.
![TTN Add Application](https://github.com/bborncr/AnarduinoMiniWireless-TTN-Getting-Started/blob/master/images/addapplication.PNG)
* In the Application Overview select Register Device.
* Add a Device ID. This is a human readable name that help identify the device. I chose `anarduino-first-node`.
* Add the Device EUI. In many cases the Device EUI comes pre-installed in the node. However, because we are creating our own node from scratch we need to invent one. The Device EUI needs 8 hexadecimal bytes. I went to https://www.random.org/bytes/ and generated a random EUI by selecting `8` bytes and `Hexadecimal`.
* The App Key will be generated by the system.
* The App EUI should already be filled in.
* Click on Register to continue.
* After sucessful registration, maintain the Device Overview page open for the next section.
![TTN Register Device](https://github.com/bborncr/AnarduinoMiniWireless-TTN-Getting-Started/blob/master/images/registerdevice.PNG)
#### Configuring the example sketch
* In order to copy the Device EUI, Application EUI and App Key to our sketch we need to modify the format and change the order of some bytes.
* In the Device Overview click on the `<>` button for each of the keys. The format should change to "C-style". See image below.
* Also ensure that the Device EUI is in `lsb` order by using the arrow button, the Application EUI should be in `lsb` order and App Key in `msb` order. See image below.
* Now copy the keys one by one into the configuration. Device EUI copies into DEVEUI. Application EUI copies into APPEUI. App Key copies into APPKEY.
![Device Keys](https://github.com/bborncr/AnarduinoMiniWireless-TTN-Getting-Started/blob/master/images/keys.PNG)
* Modify the `lmic_pinmap`:
```
// Pin mapping Anarduino
const lmic_pinmap lmic_pins = {
  .nss = 10,
  .rxtx = LMIC_UNUSED_PIN,
  .rst = 3,
  .dio = {2, 8, 7},
};
```
#### Upload the Sketch
* The default bootloader for the Anarduino is the **DUEMILANOVE**. Make sure the correct Board is selected.
* If you have a USB-Serial connector that supports 3.3V and 5V modes make sure to select **5V**.
* After the sketch uploads open the Serial Monitor and ensure that the speed is set to **9600**.
* If everything is correct, the Join process could take several seconds:
![Serial Monitor Join](https://github.com/bborncr/AnarduinoMiniWireless-TTN-Getting-Started/blob/master/images/serial.PNG)
* The Device Overview on The Things Network console should now show the Status of the last time the node contacted the gateway:
![Serial Monitor Join](https://github.com/bborncr/AnarduinoMiniWireless-TTN-Getting-Started/blob/master/images/joined.PNG)
* Click on the **Data** tab to see the incoming data. The message "hello world" will be represented in hexadecimal as `68656C6C6F20776F726C64`.
* Note that the window in the Console does not have historical data.